import UIKit

//: ---
//: ## TaskGroup
//: ### êµ¬ì¡°ì  ë™ì‹œì„±, ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ëŠ” ë‘ ë²ˆì§¸ ë°©ë²•
//: ---
//: ì•žì„œ ìš°ë¦¬ëŠ” `async let`ì„ ì‚¬ìš©í•´ **ë™ì‹œì  ë°”ì¸ë”©(concurrent binding)**ìœ¼ë¡œ
//: ì—¬ëŸ¬ í•˜ìœ„ ìž‘ì—…ì„ ë³‘ë ¬(parallel)ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì‚´íŽ´ë³´ì•˜ìŠµë‹ˆë‹¤.
//:
//: ì´ ë°©ì‹ì€ ë§¤ìš° ì§ê´€ì ì´ê³  ê°„ë‹¨í•˜ì§€ë§Œ, í•œ ê°€ì§€ **ì¹˜ëª…ì ì¸ í•œê³„ì **ì´ ìžˆìŠµë‹ˆë‹¤.
//: ë°”ë¡œ **í™•ìž¥ì„±ì´ ë–¨ì–´ì§„ë‹¤**ëŠ” ì ìž…ë‹ˆë‹¤.
//:
//: `async let`ì€ **ì •í•´ì§„ ê°œìˆ˜ì˜ ìž‘ì—…ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•´ì•¼ í•  ë•Œ**ì—ë§Œ ì í•©í•©ë‹ˆë‹¤.
//: ì˜ˆë¥¼ ë“¤ì–´, ì„œë¡œ ë‹¤ë¥¸ 5ê°œì˜ ê³ ì •ëœ í†µê³„ ë°ì´í„°ë¥¼ ê°ê° ê³„ì‚°í•´ í™”ë©´ì— ë³´ì—¬ì£¼ëŠ” ê²½ìš°ì—” ë§¤ìš° ìœ ìš©í•˜ì£ .
//:
//: í•˜ì§€ë§Œ ë§Œì•½ ìž‘ì—…ì˜ ê°œìˆ˜ê°€ **ë™ì ìœ¼ë¡œ ê²°ì •**ë˜ëŠ” ìƒí™©ì´ë¼ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?
//: ì˜ˆë¥¼ ë“¤ì–´, ì„œë²„ì—ì„œ ì‚¬ìš©ìžê°€ ìž‘ì„±í•œ **ê²Œì‹œê¸€ ëª©ë¡ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ìƒí™©**ì„ ê°€ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.

//: ---
//: ### ì˜ˆì œ 1
func fetchPosts() async -> [Post] {
    async let post1 = fetchPost(for: 1)
    async let post2 = fetchPost(for: 2)
    async let post3 = fetchPost(for: 3)
    // ðŸŸ¡ ë§Œì•½ ê°€ì ¸ì™€ì•¼ í•  ê²Œì‹œê¸€ì˜ ìˆ˜ê°€ ë” ë§Žì•„ì§„ë‹¤ë©´?

    let posts = try! await [post1, post2, post3]
    return posts
}
Task { await fetchPosts() }
//: ---

//: ìœ„ ì½”ë“œëŠ” ì§€ê¸ˆ ë‹¹ìž¥ì€ ë¬¸ì œ ì—†ì–´ ë³´ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
//: í•˜ì§€ë§Œ ê²Œì‹œê¸€ ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ê³ , ì„œë²„ì—ì„œ ë°›ì•„ì•¼ í•  ë°ì´í„° ì–‘ì´ ë§Žì•„ì§€ë©´
//: `async let`ìœ¼ë¡œ **ì¼ì¼ì´ í•˜ë“œì½”ë”©í•˜ëŠ” ë°©ì‹ì€ í•œê³„**ì— ë¶€ë”ªíž ìˆ˜ë°–ì— ì—†ìŠµë‹ˆë‹¤.
//:
//: ì´ëŸ° ê²½ìš°ì—ëŠ” ìž‘ì—…ì˜ ê°œìˆ˜ë§Œí¼ ìœ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê³  ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ìˆ˜ ìžˆëŠ”
//: **`TaskGroup`ì´ í›¨ì”¬ ë” ì í•©í•œ í•´ê²°ì±…**ì´ ë©ë‹ˆë‹¤.
//:
//: ì•„ëž˜ ì˜ˆì œëŠ” ìœ„ì˜ `async let` ê¸°ë°˜ ì½”ë“œë¥¼ **ìž‘ì—… ê·¸ë£¹(TaskGroup)** ë°©ì‹ìœ¼ë¡œ ê°œì„ í•œ ì˜ˆì œìž…ë‹ˆë‹¤.

//: ---
//: ### ì˜ˆì œ 2
func fetchPosts(until id: Int) async -> [Post] {
    await withTaskGroup(of: Post?.self, returning: [Post].self) { group in
        for id in 0..<id {
            group.addTask {
                try? await fetchPost(for: id)
            }
        }
        
        var posts: [Post] = []
        
        for await post in group {
            if let post = post {
                posts.append(post)
            }
        }
        return posts
    }
}
Task { await fetchPosts(until: 100) }
//: ---

//: `of` ë§¤ê°œë³€ìˆ˜ì—ëŠ” **ê° í•˜ìœ„ ìž‘ì—…ì´ ë°˜í™˜í•˜ëŠ” ê°’ì˜ íƒ€ìž…**ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
//: ë°˜ë©´, `returning` ë§¤ê°œë³€ìˆ˜ì—ëŠ” **ìž‘ì—… ê·¸ë£¹(TaskGroup)ì´ ìµœì¢…ì ìœ¼ë¡œ ë°˜í™˜í•  ê²°ê³¼ì˜ íƒ€ìž…**ì„ ì ìŠµë‹ˆë‹¤.


//: `fetchPosts(until:)` ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ `ìž‘ì—… ê·¸ë£¹`ì„ ì‚¬ìš©í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚ ê¹Œìš”?
//:
//: `Swift ì»´íŒŒì¼ëŸ¬`ëŠ” `fetchPosts(until:)` í•¨ìˆ˜ë¥¼ í•˜ë‚˜ì˜ **ìƒìœ„ ìž‘ì—…(Parent Task)**ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ ,
//: ê·¸ ì•ˆì—ì„œ ì„ ì–¸ëœ 100ì—¬ ê°œì˜ ê²Œì‹œê¸€ ë‹¤ìš´ë¡œë“œ ìž‘ì—…ì„ **í•˜ìœ„ ìž‘ì—…(Child Tasks)**ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” **ìž‘ì—… íŠ¸ë¦¬(Task Tree)**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

//: ---
//: ðŸ“¦ fetchPosts(until:)  â† ìƒìœ„ ìž‘ì—… (Parent Task)
//:  â”œâ”€â”€ ðŸ§µ fetchPost(for:)  â† í•˜ìœ„ ìž‘ì—… 1
//:  â”œâ”€â”€ ðŸ§µ fetchPost(for:)  â† í•˜ìœ„ ìž‘ì—… 2
//:  â”œâ”€â”€ ðŸ§µ ...
//:  â””â”€â”€ ðŸ§µ fetchPost(for:)  â† í•˜ìœ„ ìž‘ì—… 100
//: ---

//: ì´ë•Œ ìƒìœ„ ìž‘ì—…ì€ **ëª¨ë“  í•˜ìœ„ ìž‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼** ì¢…ë£Œë  ìˆ˜ ìžˆìœ¼ë©°,
//: `fetchPosts(until:)` í•¨ìˆ˜ë„ í•˜ìœ„ ìž‘ì—…ë“¤ì´ ëë‚˜ì•¼ **ì™„ì „ížˆ ë°˜í™˜**ë©ë‹ˆë‹¤.
//:
//: ì¦‰, ì´ ë¹„ë™ê¸° ìž‘ì—…ë“¤ì€ ëª¨ë‘ `downloadImagesParallel()` í•¨ìˆ˜ì˜ **ì •ì  ìŠ¤ì½”í”„(static scope)** ë‚´ì—ì„œë§Œ
//: ìœ íš¨í•˜ê²Œ ì‹¤í–‰ë˜ë©°, í•¨ìˆ˜ ë°–ì˜ ë‹¤ë¥¸ ì»¨í…ìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
//:
//: ë•ë¶„ì— ìš°ë¦¬ëŠ” ì½”ë“œì˜ ì‹¤í–‰ ë²”ìœ„ë¥¼ ëª…í™•í•˜ê²Œ íŒŒì•…í•  ìˆ˜ ìžˆê³ ,
//: ë” ì•ˆì „í•˜ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë¹„ë™ê¸° ì½”ë“œë¥¼ ìž‘ì„±í•  ìˆ˜ ìžˆê²Œ ë©ë‹ˆë‹¤.


//: ì—¬ê¸°ì„œ ì£¼ëª©í•´ì•¼ í•  ë˜ í•˜ë‚˜ì˜ í¬ì¸íŠ¸ëŠ” ë°”ë¡œ `for-await-in` êµ¬ë¬¸ìž…ë‹ˆë‹¤.
//:
//: ì´ êµ¬ë¬¸ì€ **ë¹„ë™ê¸° ë£¨í”„**ë¡œ, ìž‘ì—… ê·¸ë£¹(TaskGroup)ì— ì¶”ê°€ëœ í•˜ìœ„ ìž‘ì—… ì¤‘ **ì™„ë£Œëœ ìž‘ì—… ê²°ê³¼ê°€ ìˆœì°¨ì ìœ¼ë¡œ ë£¨í”„ì— ì „ë‹¬**ë  ë•Œë§ˆë‹¤ ì‹¤í–‰ë©ë‹ˆë‹¤.
//:
//: ì¤‘ìš”í•œ ì ì€, ìž‘ì—…ì´ ì¶”ê°€ëœ ìˆœì„œëŒ€ë¡œ ë£¨í”„ë¥¼ ë„ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì™„ë£Œëœ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ëœë‹¤ëŠ” ê²ƒìž…ë‹ˆë‹¤. ì¦‰, ë” ë¹¨ë¦¬ ëë‚˜ëŠ” ìž‘ì—…ì´ ë¨¼ì € ë£¨í”„ì— ì „ë‹¬ë˜ì–´ ì‹¤í–‰ë©ë‹ˆë‹¤.
//:
//: ì´ `for-await-in` êµ¬ë¬¸ì€ Swiftì—ì„œ ì œê³µí•˜ëŠ” **ë¹„ë™ê¸° ì‹œí€€ìŠ¤(Asynchronous Sequence)**ì˜ í•œ ì˜ˆì´ë©°, ì´ì— ëŒ€í•œ ìžì„¸í•œ ë‚´ìš©ì€ [ì• í”Œ ê³µì‹ ë¬¸ì„œ](https://developer.apple.com/documentation/swift/asyncsequence)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.



//: ìž‘ì—… ê·¸ë£¹ì—ëŠ” ì—¬ëŸ¬ ì¢…ë¥˜ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤.
//: ---
//: - `withTaskGroup(of:returning:body:)`
//: - `withThrowingTaskGroup(of:returning:body:)`
//: - `withDiscardingTaskGroup(returning:body:)`
//: - `withThrowingDiscardingTaskGroup(returning:body:)`
//: ---

//: `Throwing`ì´ ë¶™ì€ ìž‘ì—… ê·¸ë£¹ì€ í•˜ìœ„ ìž‘ì—… ì¤‘ **ì˜¤ë¥˜ë¥¼ ë˜ì§ˆ ìˆ˜ ìžˆëŠ” ìž‘ì—…**ì´ ìžˆì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
//: ë§Œì•½ ì–´ëŠ í•˜ë‚˜ì˜ í•˜ìœ„ ìž‘ì—…ì´ë¼ë„ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´, ìž‘ì—… ê·¸ë£¹ì€ ì¦‰ì‹œ ë‚˜ë¨¸ì§€ ëª¨ë“  í•˜ìœ„ ìž‘ì—…ì— ì·¨ì†Œ(cancel)ë¥¼ ì „íŒŒí•˜ê³ ,
//: ëª¨ë“  í•˜ìœ„ ìž‘ì—…ì´ ì¢…ë£Œëœ ì´í›„ì— **ì˜ˆì™¸ë¥¼ ì „ë‹¬í•˜ë©° í•¨ìˆ˜ì—ì„œ ë¹ ì ¸ë‚˜ê°‘ë‹ˆë‹¤.**.

//: `Discarding`ì´ ë¶™ì€ ìž‘ì—… ê·¸ë£¹ì€ **ê²°ê³¼ê°’ì„ ë”°ë¡œ ì €ìž¥í•˜ê±°ë‚˜ ë°˜í™˜í•  í•„ìš”ê°€ ì—†ëŠ” ìž‘ì—…**ì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
//: ì˜ˆë¥¼ ë“¤ì–´, ê° í•˜ìœ„ ìž‘ì—…ì´ `Void`ë¥¼ ë°˜í™˜í•˜ê±°ë‚˜, ë‹¨ìˆœížˆ ì‚¬ì´ë“œ ì´íŽ™íŠ¸(side-effect)ë¥¼ ìœ ë°œí•˜ëŠ” ìž‘ì—…ì— ì í•©í•©ë‹ˆë‹¤.

//: `DiscardingTaskGroup`ì€ ê° í•˜ìœ„ ìž‘ì—…ì´ ì™„ë£Œë˜ìžë§ˆìž **ì¦‰ì‹œ ë©”ëª¨ë¦¬ì—ì„œ ì œê±°ë˜ë„ë¡(eager discard)** ì„¤ê³„ë˜ì–´ ìžˆê¸° ë•Œë¬¸ì—, **`TaskGroup`ë³´ë‹¤ ë©”ëª¨ë¦¬ íš¨ìœ¨ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.**
//: ì´ëŠ” íŠ¹ížˆ í•˜ìœ„ ìž‘ì—…ì˜ ìˆ˜ê°€ ë§Žê³ , ê²°ê³¼ê°’ì´ í•„ìš” ì—†ëŠ” ê²½ìš°ì— ìœ ë¦¬í•©ë‹ˆë‹¤.

//: ---
//: ### ì˜ˆì œ 3
func cachingPosts(ids: [Int]) async throws {
    try await withThrowingDiscardingTaskGroup { group in
        for id in ids {
            group.addTask {
                try await cachingPost(id: id)
            }
        }
    }
}
Task { try? await cachingPosts(ids: [1, 2, 3]) }
//: ---
